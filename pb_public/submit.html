<div x-data="{
  currentForm: 'repertoire',
  resType: 'link',
  easyMDE: null,
  inst: new Attributes('inst'),
  os: new Attributes('os'),
  software: new Attributes('software'),
  hardware: new Attributes('hardware'),
  tags: new Attributes('tags'),
  init() {
    this.easyMDE = new EasyMDE({
      element: $refs.mdEditor
    });
    this.inst.fetchItems();
    this.os.fetchItems();
    this.software.fetchItems();
    this.hardware.fetchItems();
    this.tags.fetchItems();
  },
  async submit(e) {
    $refs.submitButton.disabled = true;
    const formData = new FormData(e.target);
    const values = Object.fromEntries(formData);
    try {
      if (this.currentForm === 'repertoire') {
        const selectedInst = formData.getAll('inst');
        if (selectedInst.length > 0) values.inst = selectedInst;
        const selectedOs = formData.getAll('os');
        if (selectedOs.length > 0) values.os = selectedOs;
        const selectedSoftware = formData.getAll('software');
        if (selectedSoftware.length > 0) values.software = selectedSoftware;
        const selectedHardware = formData.getAll('hardware');
        if (selectedHardware.length > 0) values.hardware = selectedHardware;
        const notes = this.easyMDE.value();
        if (notes) values.notes = notes;
        await createItem('repertoire', values);
      }
      if (this.currentForm === 'resource') {
        if (!values.link && !this.easyMDE.value()) {
          $store.toast.notify('Must provide either link or full text content.');
          return;
        }
        const newTagIds = [];
        if (values.new_tags) {
          const newTagNames = values.new_tags.split(',').map(t => t.trim()).filter(Boolean);
          for (const tagName of newTagNames) {
            try {
              const newTag = await pb.collection('tags').create({ name: tagName });
              newTagIds.push(newTag.id);
            } catch(err) {
              $store.toast.notify('Failed to create one or more new tags.');
            }
          }
          delete values.new_tags;
        }
        const selectedTags = formData.getAll('tags');
        values.tags = [...selectedTags, ...newTagIds];
        if (!values.tags.length) {
          $store.toast.notify('Must create or select at least one (1) Tag.');
          return;
        }
        if (this.resType != 'link') {
          delete values.link;
          values.full_text = this.easyMDE.value();
        }
        await createItem('resources', values);
      } 
    } catch(err) {
      $store.toast.notify(err.message);
    } finally {
      $refs.submitButton.disabled = false;
    }
  }
}">

  <h2>Submit</h2>

  <div class="form-group">
    <label for="currentForm">Submission Type</label>
    <div>
      <input type="radio" name="currentForm" value="repertoire" @change="currentForm = $el.value" checked>
      <span>Repertoire</span>
      <input type="radio" name="currentForm" value="resource" @change="currentForm = $el.value">
      <span>Resource</span>
    </div>
  </div>
  <template x-if="currentForm === 'resource'">
    <div class="form-group">
      <label for="resourceType">Resource Type</label>
      <div>
        <input type="radio" name="resourceType" value="link" checked @change="resType = $el.value">
        <span>External Link</span>
        <input type="radio" name="resourceType" value="full" @change="resType = $el.value">
        <span>Full Text</span>
      </div>
    </div>
  </template>
  <p>All fields are required unless otherwise indicated.</p>
  <p x-show="currentForm === 'repertoire'">
    If selecting "Other" in any field, please include clarifying details in the Notes section.
  </p>

  <hr>

  <template x-if="currentForm === 'repertoire'">
    <form x-ref="repForm" @submit.prevent="submit($event)">
      <h3>General Information</h3>
      <div class="form-group">
        <label for="title">Title</label>
        <input type="text" name="title" required>
      </div>
      <div class="form-group">
        <label for="duration">Duration</label>
        <input class="duration-input" type="text" name="duration" placeholder="m:ss" required>
      </div>
      <p class="detail">If variable, enter a typical duration and provide details in Notes.</p>
      <div class="form-group">
        <label for="composer">Composer First Name</label>
        <input type="text" name="first_name" required>
      </div>
      <div class="form-group">
        <label for="composer">Composer Last Name</label>
        <input type="text" name="last_name" required>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" name="email" required>
      </div>
      <div class="form-group">
        <label>Link to Assets</label>
        <input type="url" name="link" required>
      </div>
      <p class="detail">The Laptop Ensemble Exchange does not host files. The link you provide should direct
        users to an external site containing all necessary materials (scores, files, etc.) for performing the selection.
      </p>
      <h3>Ensemble Information</h3>
      <div class="form-group">
        <label for="difficulty">Difficulty</label>
        <select name="difficulty" required>
          <option value="">- select -</option>
          <option value="1">1 (Nov)</option>
          <option value="2">2 (Int)</option>
          <option value="3">3 (Adv)</option>
        </select>
      </div>
      <ol class="detail">
        <li>No notation reading skills required, minimal rehearsal.</li>
        <li>Requires basic notation reading and/or rhythmic coordination, regular
          rehearsal.
        </li>
        <li>Requires strong notation reading and/or rhythmic coordination, rigorous rehearsal.
        </li>
      </ol>
      <div class="form-group">
        <label for="parts">No. of Parts</label><br>
        <input type="number" name="parts" min="1" required>
      </div>
      <div class="form-group">
        <label>Maximum Performers (if applicable)</label>
        <input type="number" name="max_perf" min="1">
      </div>
      <label for="inst">Instrumentation (if applicable)</label>
      <select name="inst" multiple>
        <template x-for="item in inst.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>

      <h3>Technical Information</h3>
      <label for="os">Operating System(s)</label>
      <select name="os" multiple required>
        <template x-for="item in os.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>

      <label for="software">Software</label>
      <select name="software" multiple required>
        <template x-for="item in software.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>

      <label for="hardware">Hardware (if applicable)</label>
      <select name="hardware" multiple>
        <template x-for="item in hardware.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>
      <div class="form-group">
        <label>Visuals</label>
        <input type="checkbox" name="visuals">
      </div>
    </form>
  </template>

  <template x-if="currentForm === 'resource'">
    <form x-show="currentForm === 'resource'" x-ref="resForm" @submit.prevent="submit($event)">
      <div class="form-group">
        <label>Title</label>
        <input type="text" name="title" required>
      </div>
      <label>Description</label>
      <textarea name="description" rows="4" required></textarea>
      <p class="detail">Provide a brief catalog description. More detail should be included via link or full text below.
      </p>
      <label for="tags">Tags</label>
      <select name="tags" multiple>
        <template x-for="item in tags.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>
      <div class="form-group">
        <label for="new_tags">New Tags</label>
        <input type="text" name="new_tags" placeholder="tag1, tag2, tag3, etc.">
      </div>
      <p class="detail">Enter new tags as needed, comma separated for multiple.</p>
      <div x-show="resType === 'link'" class="form-group">
        <label>Link</label>
        <input type="url" name="link" placeholder="https://example.com">
      </div>
      <input type="hidden" name="full_text">
    </form>
  </template>

  <div x-show="currentForm === 'repertoire' || resType === 'full'">
    <label x-text="currentForm === 'repertoire' ? 'Notes' : 'Content'"></label>
    <textarea x-ref="mdEditor"></textarea>
  </div>

  <button type="button" x-ref="submitButton"
    @click="currentForm === 'repertoire' ? $refs.repForm.requestSubmit() : $refs.resForm.requestSubmit()">Submit</button>

</div>