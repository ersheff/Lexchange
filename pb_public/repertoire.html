<div x-data="{
  repertoire: new CollectionManager('repertoire'),
  inst: new AttributeManager('inst'),
  os: new AttributeManager('os'),
  software: new AttributeManager('software'),
  hardware: new AttributeManager('hardware'),
  filterExpanded: false,
  dirty: false,
  viewExpanded: false,
  columns: {
  'title':  { label: 'Title', shortLabel: 'Title', show: true },
  'duration': { label: 'Duration', shortLabel: 'Dur', show: true },
  'last_name': { label: 'Composer', shortLabel: 'Comp', show: true },
  'difficulty': { label: 'Difficulty', shortLabel: 'Diff', show: true },
  'parts': { label: 'No. of Parts', shortLabel: 'Parts', show: true },
  'max_perf': { label: 'Max Performers', shortLabel: 'Max', show: true },
  'inst': { label: 'Instrumentation', shortLabel: 'Inst', show: true, expanded: false },
  'os': { label: 'OS', shortLabel: 'OS', show: false },
  'software': { label: 'Software', shortLabel: 'SW', show: false },
  'hardware': { label: 'Hardware', shortLabel: 'HW', show: false, expanded: false },
  'visuals': { label: 'Visuals', shortLabel: 'Vis', show: true }
  },
  applyFilter(e) {
    const formData = new FormData(e.target);
    const values = Object.fromEntries(formData);
    const filters = [];
    if (values.title) filters.push(`title ${values.title_op} '${values.title}'`);
    if (values.dur_min) filters.push(`duration >= ${colonToDec(values.dur_min)}`);
    if (values.dur_max) filters.push(`duration <= ${colonToDec(values.dur_max)}`);
    if (values.last_name) filters.push(`last_name ~ '${values.last_name}'`);
    if (values.first_name) filters.push(`first_name ~ '${values.first_name}'`);
    if (values.difficulty) filters.push(`difficulty ${values.diff_op} '${values.difficulty}'`);
    if (values.parts_min) filters.push(`parts >= ${values.parts_min}`);
    if (values.parts_max) filters.push(`parts <= ${values.parts_max}`);
    if (values.max_perf) filters.push(`max_perf >= ${values.max_perf}`);
    const selectedInst = formData.getAll('inst');
    if (selectedInst.length > 0) filters.push(this.inst.createFilterString(selectedInst));
    const selectedOs = formData.getAll('os');
    if (selectedOs.length > 0) filters.push(this.os.createFilterString(selectedOs));
    const selectedSoftware = formData.getAll('software');
    if (selectedSoftware.length > 0) filters.push(this.software.createFilterString(selectedSoftware));
    const selectedHardware = formData.getAll('hardware');
    if (selectedHardware.length > 0) filters.push(this.hardware.createFilterString(selectedHardware));
    if (values.visuals) filters.push(`visuals = ${values.visuals}`);
    const filterString = filters.join(' && ');
    this.repertoire.filter = filterString;
    this.repertoire.fetchItems();
    Alpine.store('toast').notify(`Filter applied.`);
    this.dirty = false;
  },
  resetFilter() {
    this.dirty = false;
    this.repertoire.filter = '';
    this.repertoire.fetchItems();
    Alpine.store('toast').notify(`Filter reset.`);
    $refs.filterForm.reset();
  },
  init() {
    this.repertoire.fetchItems();
    this.inst.fetchItems();
    this.os.fetchItems();
    this.software.fetchItems();
    this.hardware.fetchItems();
  }
}">

  <h2>Repertoire</h2>

  <div>
    <button @click="filterExpanded = !filterExpanded"><span x-text="filterExpanded ? '△' : '▽'"></span> Show/Hide Filter
      Options</button>
  </div>

  <div x-cloak x-show="filterExpanded" x-collapse class="drawer">
    <form @submit.prevent="applyFilter($event)" x-ref="filterForm">
      <div class="form-group">
        <label for="title">Title</label>
        <select name="title_op" @change="if ($refs.filterForm.title.value) dirty = true">
          <option value="~">Contains</option>
          <option value="=">Equals</option>
        </select>
        <input type="text" name="title" @input="dirty = true">
      </div>
      <div class="form-group">
        <label for="duration">Duration Minimum</label>
        <input class="duration-input" type="text" name="dur_min" placeholder="m:ss" @input="dirty = true">
      </div>
      <div class="form-group">
        <label for="duration">Duration Maximum</label>
        <input class="duration-input" type="text" name="dur_max" placeholder="m:ss" @input="dirty = true">
      </div>
      <div class="form-group">
        <label for="composer">Composer First Name</label>
        <input type="text" name="first_name" @input="dirty = true">
      </div>
      <div class="form-group">
        <label for="composer">Composer Last Name</label>
        <input type="text" name="last_name" @input="dirty = true">
      </div>
      <div class="form-group">
        <label for="difficulty">Difficulty</label>
        <div>
          <select name="diff_op" @change="if ($refs.filterForm.difficulty.value) dirty = true">
            <option value="=">Is</option>
            <option value="!=">Is Not</option>
          </select>
          <select name="difficulty" @change="dirty = true">
            <option value="">Any</option>
            <option value="1">1 (Nov)</option>
            <option value="2">2 (Int)</option>
            <option value="3">3 (Adv)</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="parts">No. of Parts</label>
        <div>
          <input type="number" name="parts_min" placeholder="Min" min="1" @input="dirty = true">
          <input type="number" name="parts_max" placeholder="Max" min="1" @input="dirty = true">
        </div>
      </div>
      <div class="form-group">
        <label for="max_perf">Maximum Performers</label>
        <input type="number" name="max_perf" placeholder="Min" min="1" @input="dirty = true">
      </div>
      <div class="form-group">
        <label for="inst">Instrumentation</label>
        <div>
          <select @change="inst.opComb = $el.value; dirty = true">
            <option value="&&">All</option>
            <option value="||">Any</option>
            <option value="!~">Not</option>
          </select>
          <span>the following:</span>
        </div>
      </div>
      <select name="inst" multiple @change="dirty = true">
        <template x-for="item in inst.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>
      <div class="form-group">
        <label for="os">Operating System(s)</label>
        <div>
          <select @change="os.opComb = $el.value; dirty = true">
            <option value="&&">All</option>
            <option value="||">Any</option>
            <option value="!~">Not</option>
          </select>
          <span>the following:</span>
        </div>
      </div>
      <select name="os" multiple @change="dirty = true">
        <template x-for="item in os.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>
      <div class="form-group">
        <label for="software">Software</label>
        <div>
          <select @change="software.opComb = $el.value; dirty = true">
            <option value="&&">All</option>
            <option value="||">Any</option>
            <option value="!~">Not</option>
          </select>
          <span>the following:</span>
        </div>
      </div>
      <select name="software" multiple @change="dirty = true">
        <template x-for="item in software.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>
      <div class="form-group">
        <label for="hardware">Hardware</label>
        <div>
          <select @change="hardware.opComb = $el.value; dirty = true">
            <option value="&&">All</option>
            <option value="||">Any</option>
            <option value="!~">Not</option>
          </select>
          <span>the following:</span>
        </div>
      </div>
      <select name="hardware" multiple @change="dirty = true">
        <template x-for="item in hardware.items" :key="item.id">
          <option :value="item.id" x-text="item.name"></option>
        </template>
      </select>
      <p class="detail">Ctrl-click (Windows) or Command-click (Mac) to select multiple.</p>
      <div class="form-group">
        <label for="visuals">Visuals</label>
        <select name="visuals" @change="dirty = true">
          <option value="">Any</option>
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>
      <div class="form-group">
        <div>
          <button type="submit" :disabled="!dirty">Apply Filter</button>
          <button type="button" @click="resetFilter">Reset Filter</button>
        </div>
      </div>
    </form>
    <hr>
  </div>


  <div>
    <button @click="viewExpanded = !viewExpanded"><span x-text="viewExpanded ? '△' : '▽'"></span>
      Show/Hide View Options</button>
  </div>

  <div x-cloak x-show="viewExpanded" x-collapse class="drawer">
    <form>
      <div>
        <template x-for="[key, column] in Object.entries(columns)" :key="key">
          <template x-if="key !== 'title'">
            <div>
              <label x-text="column.label"></label>
              <input type="checkbox" x-model="column.show" />
              <template x-if="'expanded' in column">
                <span>
                  <label for="">Expanded View</label>
                  <input type="checkbox" x-model="column.expanded" :disabled="!column.show">
                </span>
              </template>
            </div>
          </template>
        </template>
      </div>
    </form>
    <hr>

  </div>

  <style>
    .table-scroll {
      overflow-x: scroll;
    }

    table {
      table-layout: auto;

      th {
        white-space: nowrap;

        &:hover {
          cursor: pointer;
        }
      }

      tr:not(:last-child) {
        border-bottom: 1px solid var(--border);
      }
    }
  </style>

  <div class="table-scroll">
    <table>
      <thead>
        <template x-for="[key, column] in Object.entries(columns)" :key="key">
          <th x-show="column.show"
            x-text="`${column.shortLabel} ${repertoire.sort === key ? (repertoire.order === '+' ? '▲' : '▼') : '△'}`"
            @click="repertoire.sort = key; repertoire.fetchItems()">
          </th>
        </template>
      </thead>
      <template x-for="item in repertoire.items" :key="item.id">
        <tr>
          <td x-show="columns['title'].show">
            <a :href="`?page=rep_item&id=${item.id}`" x-text="item.title" @click.prevent="route($el.href)"></a>
          </td>
          <td x-show="columns['duration'].show" x-text="decToColon(item.duration)"></td>
          <td x-show="columns['last_name'].show" x-text="`${item.last_name}, ${item.first_name}`"></td>
          <td x-show="columns['difficulty'].show" x-text="item.difficulty"></td>
          <td x-show="columns['parts'].show" x-text="item.parts"></td>
          <td x-show="columns['max_perf'].show" x-text="item.max_perf === 999 ? 'any' : item.max_perf"></td>
          <td x-show="columns['inst'].show" x-text="item.inst.length ?
          (columns['inst'].expanded ?
          item.expand.inst.map(i => i.name).join(', ') : '✓') : ''"></td>
          <td x-show="columns['os'].show" x-text="item.os.length ?
          item.expand.os.map(i => i.name).join(', ') : ''"></td>
          <td x-show="columns['software'].show" x-text="item.software.length ?
          item.expand.software.map(i => i.name).join(', ') : ''"></td>
          <td x-show="columns['hardware'].show" x-text="item.hardware.length ?
          (columns['hardware'].expanded ?
          item.expand.hardware.map(i => i.name).join(', ') : '✓') : ''"></td>
          <td x-show="columns['visuals'].show" x-text="item.visuals ? '✓' : ''"></td>
        </tr>
      </template>
    </table>
  </div>

  <hr>

  <div class="form-group">
    <div>
      <label>Page</label>
      <input type="number" min="1" :value="repertoire.page" :max="repertoire.totalPages"
        @change="repertoire.page = $el.value; repertoire.fetchItems()">
      <span x-text="` / ${repertoire.totalPages}`"></span>
    </div>
  </div>

</div>